{
  "AWSTemplateFormatVersion"  : "2010-09-09",
  "Description"               : "Cloudwick Datalake Quickstart - Cloudformation Template",
  "Parameters"                : {
                "KeyName"           : {
                      "Description"           : "Name of an existing EC2 KeyPair to enable SSH access to the instance",
                      "Type"                  : "AWS::EC2::KeyPair::KeyName",
                      "ConstraintDescription" : "Can contain only ASCII characters."

                },
                "AdministratorName" : {
                  "Description"           : "Admin Name",
                  "Type"                  : "String",
                  "ConstraintDescription" : "Can contain only ASCII characters.",
                  "Default"               : "AdminName"
                },
                "AdminEmailID"          : {
                  "Description"           : "Email ID of the Admin",
                  "Type"                  : "String",
                  "ConstraintDescription" : "Can contain only ASCII characters."

                },
                "InstanceType"      : {
                      "Description"           : "WebServer EC2 instance type",
                      "Type"                  : "String",
                      "Default"               : "m1.medium",
                      "AllowedValues"         : [ "m1.medium", "m1.large", "m1.xlarge", "m2.xlarge", "m2.2xlarge", "m2.4xlarge", "m3.medium", "m3.large", "m3.xlarge", "m3.2xlarge", "c1.medium", "c1.xlarge", "c3.large", "c3.xlarge", "c3.2xlarge", "c3.4xlarge", "c3.8xlarge"],
                      "ConstraintDescription" : "Must be a valid EC2 instance type"
                },
                "DatabaseName": {
                  "Default"                     : "datalake",
                  "Description"                 : "DB Name must start with a letter & no special characters(MinLength=4;MaxLength=20)",
                  "Type"                        : "String",
                  "MinLength"                   : "4",
                  "MaxLength"                   : "16",
                  "AllowedPattern"              : "[a-zA-Z][a-zA-Z0-9]*",
                  "ConstraintDescription"       : "DB name must start with a letter & no special characters(Min=4;Max=20 AlphaNumerics)"
                },
                "DatabaseUserName": {
                  "Default"                     : "admin",
                  "Description"                 : "DB Username must start with a letter & no special characters(MinLength=4;MaxLength=20)",
                  "Type"                        : "String",
                  "MinLength"                   : "4",
                  "MaxLength"                   : "16",
                  "AllowedPattern"              : "[a-zA-Z][a-zA-Z0-9]*",
                  "ConstraintDescription"       : "DB Username must start with a letter & no special characters(Min=4;Max=20 AlphaNumerics)"
                },
                "DatabaseUserPassword": {
                  "Description"                 : "DB Password must start with a letter,contain atleast one upper case letter & no special characters(MinLength=8;MaxLength=20)",
                  "Default"                     : "Password123",
                  "Type"                        : "String",
                  "NoEcho"                      : "true",
                  "MinLength"                   : "8",
                  "MaxLength"                   : "16",
                  "AllowedPattern"              : "[a-zA-Z]*[A-Z]+[a-zA-Z0-9]*",
                  "ConstraintDescription"       : "DB Password must start with a letter,contain atleast one upper case letter & no special characters(Min=8;Max=20 AlphaNumerics)"
                },
                "RDSClass" : {
                  "Default"                     : "db.t2.small",
                  "Description"                 : "Database instance class",
                  "Type"                        : "String",
                  "AllowedValues"               : [ "db.t2.micro", "db.t2.small", "db.t2.medium", "db.t2.large", "db.m4.large", "db.m4.xlarge", "db.m4.2xlarge", "db.m4.4xlarge", "db.m4.10xlarge" ],
                  "ConstraintDescription"       : "must select a valid database instance type."
                },
                "RDSAllocatedStorage" : {
                  "Default"                     : "5",
                  "Description"                 : "The size of the database (Gb)",
                  "Type"                        : "Number",
                  "MinValue"                    : "5",
                  "MaxValue"                    : "1024",
                  "ConstraintDescription"       : "must be between 5 and 1024Gb."
                },
                "RedshiftNodeType" : {
                  "Default"                     : "dc1.large",
                  "Description"                 : "Redshift instance type",
                  "Type"                        : "String",
                  "AllowedValues"               : [ "dc1.large", "dw.hs1.xlarge","dw1.xlarge", "dw1.8xlarge", "dw2.large", "dw2.8xlarge"],
                  "ConstraintDescription"       : "must select a valid database instance type."
                },
                "RedshiftClusterType" : {
                  "Default"                     : "single-node",
                  "Description"                 : "Redshift instance type",
                  "Type"                        : "String",
                  "AllowedValues"               : [ "single-node", "multi-node"],
                  "ConstraintDescription"       : "must select a valid database instance type."
                },
                "NumberOfNodes" : {
                  "Description"                 : "The number of compute nodes in the cluster.",
                  "Type"                        : "Number",
                  "Default"                     : "1"
                },
                "PreexistingS3" : {
                  "Description"                 : "Provide your existing S3 buckets for catalogging: s3_bucket1,s3_bucket2,...",
                  "Type"                        : "CommaDelimitedList"
                },
                "SourceLocation" : {
                  "Description"                 : "Provide your source s3 bucket name",
                  "Type"                        : "String"

                }
  },

  "Metadata" : {
    "AWS::CloudFormation::Interface" : {
    "ParameterGroups" : [
      {
        "Label" : { "default" : "Adminstrator Configuration" },
        "Parameters" : [ "AdministratorName", "AdminEmailID" ]
      },
      {
        "Label" : { "default":"Database Configuration" },
        "Parameters" : [ "DatabaseName", "DatabaseUserName", "DatabaseUserPassword" ]
      },
      {
        "Label" : { "default":"RDS Configuration" },
        "Parameters" : [ "RDSClass", "RDSAllocatedStorage" ]
      },
      {
        "Label" : { "default":"RedShift Configuration" },
        "Parameters" : [ "RedshiftClusterType" , "RedshiftNodeType" ]
      },
      {
        "Label" : { "default":"Pre-existing datasource" },
        "Parameters" : [ "PreexistingS3" ,"SourceLocation" ]
      }

    ],
    "ParameterLabels" : {
      "AdministratorName"        : { "default" : "Administrator Name" },
      "AdminEmailID"             : { "default" : "Administrator Email"},
      "DatabaseUserName"         : { "default" : "Database User Name"},
      "DatabaseUserPassword"     : { "default" : "Database User Password"},
      "DatabaseName"             : { "default" : "Database Name"}
    }
  }
},
   "Conditions" : {
      "IsMultiNodeCluster" : {
        "Fn::Equals" : [{ "Ref" : "RedshiftClusterType" }, "multi-node" ]
      }
    },



  "Mappings"  : {
        "RegiontoAmiMap" : {
                            "us-east-1"      : {"Name" :  "ami-7a3dd76c"},
                            "us-west-2"      : {"Name" :  "ami-8a72cdea"}
                      },

        "RDSEngineVersionMapping" : {
          "mysql"                       : { "latest" : "5.7"}
                      }},
  "Resources" : {


    "VpcId" : {
        "Type"        : "AWS::EC2::VPC",
        "Properties"  : {
          "CidrBlock"                 : "10.0.0.0/16",
      	  "EnableDnsSupport"          : "true",
      	  "EnableDnsHostnames"        : "true",
          "InstanceTenancy"           : "default",
          "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]
           }
       },
    "RouteTable"   :  {
          "Type" : "AWS::EC2::RouteTable",
          "DependsOn" : "AttachGateway",
          "Properties" : {
            "VpcId"                   : { "Ref" : "VpcId" },
            "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]
        }
    },

    "Route" : {
         "Type" : "AWS::EC2::Route",
         "DependsOn" : "AttachGateway",
         "Properties" : {
            "RouteTableId" : { "Ref" : "RouteTable" },
            "DestinationCidrBlock" : "0.0.0.0/0",
            "GatewayId" : { "Ref" : "InternetGateway" }
         }
      },

    "publicSubnet" : {
          "Type"        : "AWS::EC2::Subnet",
          "Properties"  : {
            "VpcId"                   : { "Ref" : "VpcId" },
            "CidrBlock"               : "10.0.0.0/24",
            "AvailabilityZone"        : {"Fn::Join" : ["",[{"Ref":"AWS::Region"},"c"]]},
            "MapPublicIpOnLaunch"     : "true",
            "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]
        }
      },
    "privateSubnet" : {
          "Type"        : "AWS::EC2::Subnet",
          "Properties"  : {
            "VpcId"                   : { "Ref" : "VpcId" },
            "CidrBlock"               : "10.0.1.0/24",
            "AvailabilityZone"        : {"Fn::Join" :["",[{"Ref":"AWS::Region"},"a"]]},
            "MapPublicIpOnLaunch"     : "true",
            "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]
        }
      },

    "publicRouteTableAssociation" : {
          "Type" : "AWS::EC2::SubnetRouteTableAssociation",
          "DependsOn" : "RouteTable",
          "Properties" : {
            "SubnetId"                : { "Ref" : "publicSubnet" },
            "RouteTableId"            : { "Ref" : "RouteTable" }
        }
    },

    "privateRouteTableAssociation" : {
          "Type" : "AWS::EC2::SubnetRouteTableAssociation",
          "DependsOn" : "RouteTable",
          "Properties" : {
            "SubnetId"                : { "Ref" : "privateSubnet" },
            "RouteTableId"            : { "Ref" : "RouteTable" }
        }
    },

    "VPCSecurityGroup" : {
          "Type"        : "AWS::EC2::SecurityGroup",
          "Properties"  : {
             "GroupDescription"       : "Security group for RDS DB Instance.",
             "VpcId"                  : { "Ref" : "VpcId" },
             "SecurityGroupIngress" : [
                              { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0" },
                              { "IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0" },
                              { "IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0" },
                              { "IpProtocol" : "tcp", "FromPort" : "3306", "ToPort" : "3306", "CidrIp" : "0.0.0.0/0" },
                              { "IpProtocol" : "tcp", "FromPort" : "5439", "ToPort" : "5439", "CidrIp" : "0.0.0.0/0" },
                              { "IpProtocol" : "tcp", "FromPort" : "8080", "ToPort" : "8080", "CidrIp" : "0.0.0.0/0" },
                              { "IpProtocol" : "tcp", "FromPort" : "8282", "ToPort" : "8282", "CidrIp" : "0.0.0.0/0" },
                              { "IpProtocol" : "icmp", "FromPort" : "-1", "ToPort" : "-1", "CidrIp" : "0.0.0.0/0" }
                            ],
             "SecurityGroupEgress"    : [ {"CidrIp": "0.0.0.0/0","IpProtocol": "-1"} ],
             "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]
          }
      },

    "InternetGateway" : {
        "Type"        : "AWS::EC2::InternetGateway",
        "Properties"  : {"Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]}
      },

    "AttachGateway" : {
       "Type"         : "AWS::EC2::VPCGatewayAttachment",
       "DependsOn"    : "InternetGateway",
       "Properties"   : {
            "VpcId"                   : { "Ref" : "VpcId" },
            "InternetGatewayId"       : { "Ref" : "InternetGateway" }
       }
    },

    "RDSDBSubnetGroup" : {
        "Type"          : "AWS::RDS::DBSubnetGroup",
        "Properties"    : {
          "DBSubnetGroupDescription"  : "Subnets available for the RDS DB Instance",
          "SubnetIds"                 : [ { "Ref" : "publicSubnet" }, { "Ref" : "privateSubnet" }]
        }
      },
    "RDSDB" : {
        "Type"          : "AWS::RDS::DBInstance",
        "Properties"    : {
          "DBName"                    : { "Ref"   : "DatabaseName" },
          "Port"                      : "3306",
          "AllocatedStorage"          : { "Ref"   : "RDSAllocatedStorage" },
          "DBInstanceClass"           : { "Ref"   : "RDSClass" },
          "Engine"                    : "mysql",
          "EngineVersion"             : { "Fn::FindInMap" : [ "RDSEngineVersionMapping", "mysql", "latest"]},
          "MasterUsername"            : { "Ref"   : "DatabaseUserName" } ,
          "MasterUserPassword"        : { "Ref"   : "DatabaseUserPassword" },
          "StorageType"               : "gp2",
          "DBSubnetGroupName"         : { "Ref"   : "RDSDBSubnetGroup" },
          "VPCSecurityGroups"         : [ { "Ref" : "VPCSecurityGroup" } ],
          "PubliclyAccessible"        : "true",
          "DBInstanceIdentifier"      : {"Fn::Join" : [ "",[ "cloudwick-datalake-rds-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
          "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]
        },
        "DeletionPolicy" : "Delete"
      },



        "RedshiftClusterParameterGroup" : {
            "Type"          : "AWS::Redshift::ClusterParameterGroup",
            "Properties"    : {
              "Description"               : "Cluster parameter group",
              "ParameterGroupFamily"      : "redshift-1.0",
              "Parameters"                : [ {"ParameterName" : "enable_user_activity_logging", "ParameterValue" : "true"}]
            }
          },

        "RedshiftCluster"   : {
          "Type"            : "AWS::Redshift::Cluster",
          "Properties"      : {
            "DBName"                      : { "Ref" : "DatabaseName" },
            "MasterUsername"              : { "Ref" : "DatabaseUserName" },
            "MasterUserPassword"          : { "Ref" : "DatabaseUserPassword" },
            "NodeType"                    : { "Ref" : "RedshiftNodeType" },
            "ClusterType"                 : { "Ref" : "RedshiftClusterType" },
            "NumberOfNodes"               : { "Fn::If"  : [ "IsMultiNodeCluster", {"Ref" : "NumberOfNodes"}, {"Ref" : "AWS::NoValue"}]},
            "ClusterParameterGroupName"   : { "Ref"     : "RedshiftClusterParameterGroup" },
            "VpcSecurityGroupIds"         : [ { "Ref"   : "VPCSecurityGroup" }] ,
            "ClusterSubnetGroupName"      : { "Ref" : "RedshiftClusterSubnetGroup" }
                    }
        },

        "RedshiftClusterSubnetGroup" : {
            "Type"          : "AWS::Redshift::ClusterSubnetGroup",
            "Properties"    : {
                "Description"             : "Cluster subnet group",
                "SubnetIds"               : [ { "Ref" : "privateSubnet" } ]
                            }
            },

    "ElasticsearchDomain": {
       "Type": "AWS::Elasticsearch::Domain",
       "Properties": {
         "DomainName": {"Fn::Join" : [ "",[ "cloudwick-dles-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
          "ElasticsearchVersion": "5.1",
          "ElasticsearchClusterConfig": {
                                     "DedicatedMasterEnabled"      : "false",
                                     "InstanceCount"               : "1",
                                      "ZoneAwarenessEnabled"        : false,
                                     "InstanceType"                : "t2.medium.elasticsearch"
                                       },
         "EBSOptions"                : {
                                     "EBSEnabled": true,
                                     "Iops": 0,
                                     "VolumeSize": 20,
                                     "VolumeType": "gp2"
                       },
         "SnapshotOptions"           : {
                                     "AutomatedSnapshotStartHour": "0"
         },
         "AccessPolicies": {
           "Version": "2012-10-17",
           "Statement": [{
             "Effect": "Allow",
             "Principal": {
               "AWS": ["*"]
             },
             "Action": ["es:*"],
             "Resource"  : {"Fn::Join" : [ "",[ "arn:aws:es:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":domain/cloudwick-dles-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] }, "/*" ]]}
           }]
         },
         "AdvancedOptions": {
           "rest.action.multi.allow_explicit_index": "true"
         },
          "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  }]
       }
     },

              "LambdaExecutionRole" : {
                                    "Type"        : "AWS::IAM::Role",
                                    "DependsOn"   : "RedshiftSecondaryRole",
                                    "Properties"  : {
                                                  "RoleName"       : {"Fn::Join" : [ "",[ "cloudwick-datalake-lambdaExecutionRole-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                                      "AssumeRolePolicyDocument"  : {
                                                          "Version"   : "2012-10-17",
                                                          "Statement" : [{
                                                                  "Effect"    : "Allow",
                                                                  "Principal" : {
                                                                          "Service"   : [ "lambda.amazonaws.com" ]
                                                              },
                                                                  "Action"    :  [ "sts:AssumeRole" ]
                                                              }]
                                                    },

                                                      "Path"        : "/",
                                                      "Policies"    : [{
                                                            "PolicyName"        :{"Fn::Join" : [ "",[ "cloudwick-datalake-catlamb-policy-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                                            "PolicyDocument"    : {
                                                                      "Version"       : "2012-10-17",
                                                                      "Statement"     : [
                                                                                   {
                                                                                        "Effect": "Allow",
                                                                                        "Action": "s3:*",
                                                                                        "Resource": "*"
                                                                                    },
                                                                                    {
                                                                                         "Effect": "Allow",
                                                                                         "Action": [
                                                                                             "logs:CreateLogGroup",
                                                                                             "logs:CreateLogStream",
                                                                                             "logs:PutLogEvents",
                                                                                             "logs:DescribeLogStreams"
                                                                                         ],
                                                                                         "Resource": ["arn:aws:logs:*:*:*" ]
                                                                                     },
                                                                                    {
                                                                                       "Effect": "Allow",
                                                                                       "Action": [
                                                                                           "es:*"
                                                                                       ],
                                                                                       "Resource":[{"Fn::Join" : [ "", ["arn:aws:es:::domain/cloudwick-dles-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] },":*"]]}]
                                                                                   },
                                                                                   {
                                                                                       "Effect": "Allow",
                                                                                       "Action": "iam:PassRole",
                                                                                       "Resource": [
                                                                                           {"Fn::Join" : [ "",[ "arn:aws:iam:::role/",{"Ref":"RedshiftSecondaryRole"} ]  ] },
                                                                                           {"Fn::Join" : [ "",[ "arn:aws:redshift:::",{"Ref":"RedshiftCluster"},"/",{"Ref": "DatabaseUserName"} ]  ] }
                                                                                       ]
                                                                                   }
                                                                  ]}}]
                                                          }
                                      },

                                      "RedshiftSecondaryRole" : {
                                                            "Type"        : "AWS::IAM::Role",
                                                            "Properties"  : {
                                                                          "RoleName"       : {"Fn::Join" : [ "",[ "cloudwick-datalake-RedshiftSecondaryRole-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                                                              "AssumeRolePolicyDocument"  : {
                                                                                  "Version"   : "2012-10-17",
                                                                                  "Statement" : [{
                                                                                          "Effect"    : "Allow",
                                                                                          "Principal" : {
                                                                                                  "Service"   : [ "redshift.amazonaws.com" ]
                                                                                      },
                                                                                          "Action"    :  [ "sts:AssumeRole" ]
                                                                                      }]
                                                                            },

                                                                              "Path"        : "/",
                                                                              "Policies"    : [{
                                                                                    "PolicyName"        :{"Fn::Join" : [ "",[ "cloudwick-datalake-RedshiftSecondaryRole-policy-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                                                                    "PolicyDocument"    : {
                                                                                              "Version"       : "2012-10-17",
                                                                                              "Statement"     : [
                                                                                                           {
                                                                                                                "Effect": "Allow",
                                                                                                                "Action": "s3:*",
                                                                                                                "Resource": {"Fn::Join" : [ "", ["arn:aws:s3:::cloudwick-datalake-", { "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] },"/*"]]}
                                                                                                            }
                                                                                          ]}}]
                                                                                  }
                                                              },


              "LambdafunctionES": {
                                   "DependsOn"          : "WebserverWaitCondtion",
                                   "Type"               : "AWS::Lambda::Function",
                                   "Properties"         : {
                                                    "FunctionName": {"Fn::Join" : [ "",[ "cloudwick-datalake-catlamb-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                                    "Handler"     : "lambda_function.lambda_handler",
                                                    "Role"        : { "Fn::GetAtt"  :   ["LambdaExecutionRole", "Arn"] },
                                                    "Code"        : {

                                                                    "S3Bucket"    : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                                                    "S3Key"       : "lambdas/writetoESX.zip"
                                                                  },
                                                    "Runtime": "python2.7",
													"Timeout": "180"
                                   }
                                 },

                               "DLS3Bucket" : {
                                 "Type" : "AWS::S3::Bucket",
                                 "DeletionPolicy" : "Delete",
                                 "Properties": {
                                       "AccessControl" : "PublicReadWrite",
                                       "BucketName"    : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                       "VersioningConfiguration": {
                                                           "Status": "Enabled"
                                                         },
                                       "LifecycleConfiguration" : {
                                         "Rules" : [{
                                             "ExpirationInDays" : 45,
                                             "Status" : "Enabled",
                                             "Id" : "DatalakeLCP",
                                             "Transitions" : [{
                                                 "TransitionInDays": 30,
                                                 "StorageClass": "GLACIER"
                                             }]
                                         }]
                                      }
                                     }
                                   },

                 "s3Interimbucketpolicy" : {
                       "Type"        : "AWS::S3::BucketPolicy",
                       "DependsOn"   : "DLS3Bucket",
                       "Properties"  : {
                                       "Bucket"          : {"Ref" : "DLS3Bucket"},
                                       "PolicyDocument"  : {
                                                           "Statement":[
                                                             {
                                                                      "Sid": "AWSCloudTrailAclCheckintermediate",
                                                                      "Effect": "Allow",
                                                                      "Principal": {
                                                                          "Service": "cloudtrail.amazonaws.com"
                                                                      },
                                                                      "Action": "s3:GetBucketAcl",
                                                                      "Resource": {"Fn::Join" : ["",["arn:aws:s3:::cloudwick-datalake-",{"Ref":"AWS::AccountId"},"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}
                                                                   },
                                                                   {
                                                                      "Sid": "AWSCloudTrailWriteintermediate",
                                                                      "Effect": "Allow",
                                                                      "Principal": {
                                                                          "Service": "cloudtrail.amazonaws.com"
                                                                      },
                                                                      "Action": "s3:PutObject",
                                                                      "Resource": {"Fn::Join" : ["",["arn:aws:s3:::cloudwick-datalake-",{"Ref":"AWS::AccountId"},"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] }, "/CloudTrailLogs/AWSLogs/",{"Ref":"AWS::AccountId"},"/*" ]]},
                                                                      "Condition": {
                                                                          "StringEquals": {
                                                                              "s3:x-amz-acl": "bucket-owner-full-control"
                                                                          }
                                                                      }
                                                                   }



                                                                       ]
                                       }
                                     }
                       },

          "datalakecloudtrail" : {

                             "Type" : "AWS::CloudTrail::Trail",
                             "DependsOn" : "s3Interimbucketpolicy",
                             "Properties" : {
                                       "S3BucketName" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
                                       "S3KeyPrefix"  : "CloudTrailLogs",
                                       "IsLogging" : true
                                           }
                                         },

               "s3bucketpolicy" : {
                     "Type"        : "AWS::S3::BucketPolicy",
                     "DependsOn"   : "datalakecloudtrail",
                     "Properties"  : {
                                     "Bucket"          : {"Ref" : "DLS3Bucket"},
                                     "PolicyDocument"  : {
                                                         "Statement":[{
                                                                       "Sid"               : "DenyIncorrectEncryptionHeader",
                                                                       "Effect"            : "Deny",
                                                                       "Principal"         : "*",
                                                                       "Action"            : "s3:PutObject",
                                                                       "Resource"          : {"Fn::Join" : ["",["arn:aws:s3:::cloudwick-datalake-",{"Ref":"AWS::AccountId"},"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] },"/*" ]]},
                                                                       "Condition": {
                                                                         "StringNotEquals": {
                                                                           "s3:x-amz-server-side-encryption": "AES256"
                                                                         }
                                                                       }

                                                           },
                                                           {
                                                                       "Sid"                 : "DenyUnEncryptedObjectUploads",
                                                                       "Effect"              : "Deny",
                                                                       "Principal"           : "*",
                                                                       "Action"              : "s3:PutObject",
                                                                       "Resource"            : {"Fn::Join" : ["",["arn:aws:s3:::cloudwick-datalake-",{"Ref":"AWS::AccountId"},"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] },"/*" ]]},
                                                                       "Condition": {
                                                                         "Null": {
                                                                           "s3:x-amz-server-side-encryption": "true"
                                                                         }
                                                                       }
                                                                     }



                                                         ]
                                     }

                     }
               },

    "EC2WebserverIamProfile" : {
                        "Type"        : "AWS::IAM::InstanceProfile",
                        "Properties"  : {
                                                    "Path" : "/",
                                                    "Roles" : [ { "Ref" : "EC2WebserverRole" } ]
                                          }
                                },
    "EC2WebserverRole": {
       "Type"           : "AWS::IAM::Role",
       "Properties"     : {
          "RoleName"       : {"Fn::Join" : [ "",[ "cloudwick-dl-webserver-role-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
          "AssumeRolePolicyDocument"  : {
                                           "Version"  : "2012-10-17",
                                           "Statement": [ {
                                                          "Effect": "Allow",
                                                          "Principal": {
                                                                    "Service": [ "ec2.amazonaws.com" ]
                                                                        },
                                                          "Action": [ "sts:AssumeRole" ]
                                           } ]
          },
          "Path"      : "/",
          "Policies"  : [ {
             "PolicyName"       : {"Fn::Join" : [ "",[ "cloudwick-dl-webserver-policy-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]},
             "PolicyDocument"   : {
                                          "Version"   : "2012-10-17",
                                          "Statement" : [ {
                                                            "Effect": "Allow",
                                                            "Action": "*",
                                                            "Resource": "*"
														                              } ]
														     }
                        } ]
                        }
    },

    "WebServerInstance": {
       "Type"           : "AWS::EC2::Instance",
       "DependsOn"      : ["ElasticsearchDomain"],
       "Metadata"       : {
                "Comment1"     : "Configure the bootstrap helpers to install the Apache Web Server and PHP",

       "AWS::CloudFormation::Init" : {
         "configSets" : {
           "Install" : [ "Repset", "Install" ]
         },

         "Repset"  :{
                     "commands" : {
                                   "repoinstall" : {"command" : {"Fn::Join":["",["rpm -Uvh https://s3.us-east-2.amazonaws.com/",{"Ref":"SourceLocation"},"/configuration/repo/latest.rpm"]]}}
                                   }
                   },
         "Install" : {
         "packages" : {
                       "yum" : {
                                 "mysql-config"            : [],
                                 "mysql55-server"          : [],
                                 "php56w-mbstring"         : [],
                                 "php56w-mysql"            : [],
                                 "php56w-gd"               : [],
                                 "php56w-cli"              : [],
                                 "php56w"                  : [],
                                 "php56w-xml"              : [],
                                 "httpd"                   : [],
                                 "php56w-pgsql"            : []
                               }
                       },
         "services" : {
                       "sysvinit" : {
                                 "httpd"            : {"enabled" : "true", "ensureRunning" : "true"},
                                 "mysqld"           : {"enabled" : "true", "ensureRunning" : "true"}
                       }
                     }
                   }
                 }
            },
       "Properties": {
          "ImageId"             : { "Fn::FindInMap" : [ "RegiontoAmiMap", { "Ref" : "AWS::Region" }, "Name"]},
          "Tags" : [{"Key" : "solution", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-",{ "Ref":"AWS::AccountId" },"-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}  },{"Key" : "Name", "Value" : {"Fn::Join" : [ "",[ "cloudwick-datalake-webserver-",{"Fn::Select": ["4",{"Fn::Split": ["-",{ "Fn::Select" : [ "2",{ "Fn::Split": ["/",{"Ref": "AWS::StackId"} ] } ] } ] } ] } ]]}}],
          "IamInstanceProfile"  : {"Ref" : "EC2WebserverIamProfile"},
          "InstanceType"        : { "Ref" : "InstanceType" },
          "KeyName"             : { "Ref" : "KeyName" },
          "UserData"            : { "Fn::Base64" : { "Fn::Join" : ["", [
            "#!/bin/bash -xe\n",
            "yum install -y aws-cfn-bootstrap\n",
            "yum clean all\n",
            "/opt/aws/bin/cfn-init ",
            "         --stack ", { "Ref" : "AWS::StackName" },
            "         --resource WebServerInstance ",
            "         --configsets Install ",
            "         --region ", { "Ref" : "AWS::Region" }, "\n",
            "wget https://s3.us-east-2.amazonaws.com/",{"Ref":"SourceLocation"},"/configuration/starter/configure.sh;cat configure.sh | tr -d '\r' > configure_l.sh;chmod 777 configure_l.sh;./configure_l.sh ",
            {"Ref":"AWS::AccountId"}," ",{"Ref":"AWS::Region"}," ",{"Ref":"DatabaseUserName"}," ",{"Ref":"DatabaseUserPassword"}," ",{"Ref":"AdminEmailID"}," ",
            { "Fn::GetAtt": [ "RDSDB", "Endpoint.Address" ] }," ",
            { "Fn::GetAtt" : [ "RedshiftCluster", "Endpoint.Address" ] }," ",
            { "Fn::GetAtt": [ "RedshiftSecondaryRole", "Arn" ] }," ",{"Ref":"RDSDB"}," ",{"Ref":"DatabaseName"}," ",{"Ref":"RedshiftCluster"}," ",{"Ref":"DatabaseName"}," ",
            {"Fn::GetAtt" : ["ElasticsearchDomain","DomainEndpoint"]}," ",
            {"Ref":"DLS3Bucket"}," ",{"Ref":"AWS::StackId"}," ",{"Fn::Select": ["4",{"Fn::Split": ["-",{"Fn::Select" : [ "2",{"Fn::Split": ["/",{"Ref": "AWS::StackId"}]}]}]}]}," ",
            {"Ref":"AWS::StackName"}," ",
            {"Ref":"SourceLocation"}," ",{"Ref":"SourceLocation"}," ",{"Ref":"SourceLocation"}," ",{"Ref":"SourceLocation"}," ",{"Ref":"SourceLocation"}," ",
            {"Ref":"SourceLocation"}," ",{"Ref":"SourceLocation"}," \n",
            "/opt/aws/bin/cfn-signal ",
            "         -e 0",
            "        ",{"Fn::Base64":{"Ref" : "WebserverWaitHandle"}},"\n"
                  ]]}},


           "NetworkInterfaces": [{
           "AssociatePublicIpAddress": "true",
           "DeviceIndex": "0",
           "GroupSet": [{ "Ref" : "VPCSecurityGroup" }],
           "SubnetId": { "Ref" : "publicSubnet"}
                                }],

           "BlockDeviceMappings" : [
               {
                  "DeviceName" : "/dev/sda1",
                  "Ebs" : {
                     "VolumeType" : "gp2",
                     "DeleteOnTermination" : "true",
                     "VolumeSize" : "30"
                  }
               }]
            }
        },

    "WebserverWaitHandle" : {
                              "Type"          : "AWS::CloudFormation::WaitConditionHandle",
                              "Properties"    : {}
    },

    "WebserverWaitCondtion" : {
                            "Type"            : "AWS::CloudFormation::WaitCondition",
                            "DependsOn"       : "WebServerInstance",
                            "Properties"      : {
                                                "Handle"      : {"Ref": "WebserverWaitHandle"},
                                                "Timeout"     : "800"
                            }

    }





  },
  "Outputs" : {
                "WaitConditionHandle" : {
                  "Description" : "---",
                  "Value"       : {"Fn::Base64": {"Ref":"WebserverWaitHandle"}}
                },
                "S3Bucket"            : {
                  "Description" : "S3bucket",
                  "Value"       : {"Ref" : "DLS3Bucket"}
                },
                "ElasticSearchEndpoint" : {
                  "Description" : "ElasticSearchEndpoint",
                  "Value"       : {"Fn::GetAtt" : ["ElasticsearchDomain","DomainEndpoint"]}
                },
                "lambdaName"    : {
                  "Description" : "LambdaName",
                  "Value"       : {"Ref" : "LambdafunctionES"}
                },
                "VPCInfo"    : {
                  "Description"   : "New VPC Info",
                  "Value"         : {"Ref" : "VpcId"}
                },
                "RDSEndpoint": {
                  "Description"                 : "RDS endpoint",
                  "Value"                       : { "Fn::GetAtt": [ "RDSDB", "Endpoint.Address" ] }
                },
                "RedshiftClusterEndpoint" : {
                  "Description"                 : "Redshift Cluster endpoint",
                  "Value"                       : { "Fn::GetAtt" : [ "RedshiftCluster", "Endpoint.Address" ] }
                },

                "RedshiftSecondaryRole" : {
                  "Description"                 : "Ref - RedshiftSecondaryRole ",
                  "Value"                       : { "Ref" : "RedshiftSecondaryRole"}
                }

  }
}